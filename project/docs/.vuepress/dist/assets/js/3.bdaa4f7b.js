(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{163:function(t,s,a){t.exports=a.p+"assets/img/log.a7c1d13d.jpg"},202:function(t,s,a){t.exports=a.p+"assets/img/jxwaf-mini3.b202baea.png"},203:function(t,s,a){t.exports=a.p+"assets/img/project.16e25aa5.jpg"},204:function(t,s,a){t.exports=a.p+"assets/img/logstore.f404571c.jpg"},205:function(t,s,a){t.exports=a.p+"assets/img/create1.d5d2ec2a.jpg"},206:function(t,s,a){t.exports=a.p+"assets/img/create2.45bbdeb8.jpg"},207:function(t,s,a){t.exports=a.p+"assets/img/create3.145d9eca.jpg"},208:function(t,s,a){t.exports=a.p+"assets/img/create4.b8cdfa4f.jpg"},209:function(t,s,a){t.exports=a.p+"assets/img/create5.aa6d2ea7.jpg"},210:function(t,s,a){t.exports=a.p+"assets/img/create6.17da9b54.jpg"},211:function(t,s,a){t.exports=a.p+"assets/img/create7.6e1b2444.jpg"},212:function(t,s,a){t.exports=a.p+"assets/img/create8.14bf5d82.jpg"},213:function(t,s,a){t.exports=a.p+"assets/img/create9.a5c0d7f3.jpg"},214:function(t,s,a){t.exports=a.p+"assets/img/domain.90e88a40.jpg"},215:function(t,s,a){t.exports=a.p+"assets/img/ali.5d5bcd9b.jpg"},216:function(t,s,a){t.exports=a.p+"assets/img/chart.3e1372d4.jpg"},227:function(t,s,a){"use strict";a.r(s);var e=a(28),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"jxwaf最佳实践"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#jxwaf最佳实践"}},[t._v("#")]),t._v(" JXWAF最佳实践")]),t._v(" "),e("h2",{attrs:{id:"部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[t._v("#")]),t._v(" 部署")]),t._v(" "),e("h4",{attrs:{id:"架构图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#架构图"}},[t._v("#")]),t._v(" 架构图")]),t._v(" "),e("p",[e("img",{attrs:{src:a(202),alt:""}})]),t._v(" "),e("ul",[e("li",[t._v("蓝色为jxwaf节点的部署位置")]),t._v(" "),e("li",[t._v("日志对接的是阿里云日志服务")])]),t._v(" "),e("h4",{attrs:{id:"环境准备"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境准备"}},[t._v("#")]),t._v(" 环境准备")]),t._v(" "),e("ul",[e("li",[t._v("jxwaf节点\n"),e("ul",[e("li",[t._v("Centos 7.4")])])]),t._v(" "),e("li",[t._v("jxwaf控制台\n"),e("ul",[e("li",[t._v("Centos 7.4")])])]),t._v(" "),e("li",[t._v("数据库\n"),e("ul",[e("li",[t._v("Mysql/Mariadb")])])])]),t._v(" "),e("h4",{attrs:{id:"快速部署-源码部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#快速部署-源码部署"}},[t._v("#")]),t._v(" 快速部署(源码部署)")]),t._v(" "),e("p",[e("strong",[t._v("控制台部署")])]),t._v(" "),e("p",[t._v("需要先部署好数据库，假设数据库地址为192.168.1.1，端口为3306，账号为root，密码为123456，数据库为jxwaf")]),t._v(" "),e("ol",[e("li",[t._v("$ yum install git -y")]),t._v(" "),e("li",[t._v("$ cd /opt")]),t._v(" "),e("li",[t._v("$ git clone https://github.com/jx-sec/jxwaf-mini-server.git")]),t._v(" "),e("li",[t._v("$ cd jxwaf-mini-server/")]),t._v(" "),e("li",[t._v("$ sh install.sh")]),t._v(" "),e("li",[t._v("$ pip install -r requirements.txt")]),t._v(" "),e("li",[t._v("$ vim jxwaf2018/settings.py")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("# Database\n# https://docs.djangoproject.com/en/1.9/ref/settings/#databases\n#DATABASES = {\n#    'default': {\n#        'ENGINE': 'django.db.backends.sqlite3',\n#        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),\n#    }\n#}\n\nDATABASES = {\n 'default': {\n     'ENGINE': 'django.db.backends.mysql',\n     'NAME': 'jxwaf',\n     'USER': 'root',\n     'PASSWORD': '123456',\n     'HOST': '192.168.1.1',\n     'PORT': '3306',\n }\n}\n\n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[t._v("$ python manage.py makemigrations")]),t._v(" "),e("li",[t._v("$ python manage.py migrate")]),t._v(" "),e("li",[t._v("$ nohup python manage.py runserver 0.0.0.0:80 &")]),t._v(" "),e("li",[t._v("假设服务器IP为10.0.0.1,则打开网址 http://10.0.0.1 进行注册,注册完后登录账号,在 WAF更新-> 语义引擎更新 中选择 语义引擎版本 加载。在 WAF更新-> 人机识别更新 中 选择 人机识别版本 加载，同时点击 KEY更新 加载人机识别对应的 KEY")]),t._v(" "),e("li",[t._v("生产环境建议通过nginx+uwsgi部署，详情可参考文档 https://www.runoob.com/django/django-nginx-uwsgi.html 或自行百度。直接部署默认为调试模式，不要直接对公网开放访问。")]),t._v(" "),e("li",[t._v("注册账号后，可通过 jxwaf2018/settings.py 文件中的 OPEN_REGIST = True 修改为 OPEN_REGIST = False 来关闭账号注册功能")])]),t._v(" "),e("p",[e("strong",[t._v("节点部署")])]),t._v(" "),e("ol",[e("li",[t._v("$ yum install git -y")]),t._v(" "),e("li",[t._v("$ cd /tmp")]),t._v(" "),e("li",[t._v("$ git clone https://github.com/jx-sec/jxwaf.git")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("提示: 国内服务器github下载较慢，提供百度网盘下载\nhttps://pan.baidu.com/s/1WAt077rrOSNZj1E4X1u6pw 提取码: vcgw \n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[t._v("$ cd jxwaf")]),t._v(" "),e("li",[t._v("$ sh install_waf.sh")]),t._v(" "),e("li",[t._v("$ 运行后显示类似信息即安装成功:")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("nginx: the configuration file /opt/jxwaf/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /opt/jxwaf/nginx/conf/nginx.conf test is successful\n")])])]),e("ol",{attrs:{start:"7"}},[e("li",[t._v('假设管理中心IP为10.0.0.1,则打开网址 http://10.0.0.1 进行注册,注册完后登录账号,在WAF管理下的全局配置页面获取"api key"和"api password"')]),t._v(" "),e("li",[t._v("$ cd tools")]),t._v(" "),e("li",[t._v("$ python jxwaf_local_init.py --api_key=a2dde899-96a7-40s2-88ba-31f1f75f1552 --api_password=653cbbde-1cac-11ea-978f-2e728ce88125 --waf_server=http://10.0.0.1")]),t._v(" "),e("li",[t._v('api_key 为全局配置页面中"api key"的值，api_password为"api password"的值，运行完成后，显示类似信息即安装成功')])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("config file:  /opt/jxwaf/nginx/conf/jxwaf/jxwaf_config.json\nconfig result:\ninit success,access_id is d7b9fe12-606c-4ca8-bcb5-3dde9853e5f4,access_secret is af5cfc8d-d564-44dd-ba11-f1fecdf95706 \nauth result:\ntry to connect jxwaf server auth api_key and api_password,result is True\n")])])]),e("ol",{attrs:{start:"11"}},[e("li",[t._v("$ /opt/jxwaf/nginx/sbin/nginx")]),t._v(" "),e("li",[t._v("启动openresty,openresty会在启动或者reload的时候自动到jxwaf管理中心拉取用户配置的最新规则,之后会定期同步配置,周期可在全局配置页面设置。")])]),t._v(" "),e("h4",{attrs:{id:"阿里云日志部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#阿里云日志部署"}},[t._v("#")]),t._v(" 阿里云日志部署")]),t._v(" "),e("ol",[e("li",[t._v("创建Project")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(203),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[t._v("创建Logstore")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(204),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[t._v("安装logtail")])]),t._v(" "),e("p",[t._v("Logtail客户端是阿里云日志服务提供的日志采集客户端")]),t._v(" "),e("p",[e("img",{attrs:{src:a(205),alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:a(206),alt:""}})]),t._v(" "),e("p",[e("img",{attrs:{src:a(207),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[t._v("$ wget http://logtail-release-cn-shenzhen.oss-cn-shenzhen.aliyuncs.com/linux64/logtail.sh -O logtail.sh; chmod 755 logtail.sh; ./logtail.sh install cn-shenzhen-internet")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('logtail-linux64.tar.gz download success\ninstall logtail files success\nchkconfig add ilogtaild success\ninstall logtail success\nilogtail is running\nstart logtail success\n{\n   "UUID" : "8A134173-30E7-4CC9-B924-34ABEC00D81B",\n   "hostname" : "VM-16-12-centos",\n   "instance_id" : "C36692DC-0C6D-11EB-A61A-525400473BD9_172.16.16.12_1602495113",\n   "ip" : "172.16.16.12",\n   "logtail_version" : "0.16.48",\n   "os" : "Linux; 3.10.0-693.el7.x86_64; #1 SMP Tue Aug 22 21:09:27 UTC 2017; x86_64",\n   "update_time" : "2020-10-12 17:31:53"\n}\n')])])]),e("ol",{attrs:{start:"5"}},[e("li",[t._v("创建主账号AliUid同名文件到 /etc/ilogtail/users 目录，如目录不存在请手动创建目录。一台服务器上可以配置多个主账号AliUid，例如：")])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("touch /etc/ilogtail/users/1833192882890167\ntouch /etc/ilogtail/users/1833192882890167\n")])])]),e("ol",{attrs:{start:"6"}},[e("li",[t._v("创建机器组，ip为步骤4中的输出，这里为172.16.16.12")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(208),alt:""}})]),t._v(" "),e("p",[t._v("7.机器组创建成功\n"),e("img",{attrs:{src:a(209),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"8"}},[e("li",[t._v("数据源设置")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(210),alt:""}})]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('{\n    "inputs": [\n        {\n            "detail": {\n                "ParseProtocol": "auto",\n                "Address": "tcp://0.0.0.0:5555"\n            },\n            "type": "service_syslog"\n        }\n    ],\n    "processors": [\n        {\n            "detail": {\n                "DropKeys": [\n                    "_facility_",\n                    "_hostname_",\n                    "_ip_",\n                    "_priority_",\n                    "_program_",\n                    "_severity_",\n                    "_unixtimestamp_"\n                ]\n            },\n            "type": "processor_drop"\n        },\n        {\n            "detail": {\n                "KeepSource": false,\n                "ExpandDepth": 0,\n                "ExpandConnector": "",\n                "SourceKey": "_content_",\n                "NoKeyError": true\n            },\n            "type": "processor_json"\n        }\n    ]\n}\n')])])]),e("ol",{attrs:{start:"9"}},[e("li",[t._v("索引生成")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(211),alt:""}})]),t._v(" "),e("p",[t._v("该步骤可以在后续手动创建，不过建议通过日志来自动生成，可参考如下设置，细节请查看后续的 配置 章节。")]),t._v(" "),e("p",[t._v("在控制台 全局配置 -> 日志配置")]),t._v(" "),e("p",[e("img",{attrs:{src:a(163),alt:""}})]),t._v(" "),e("p",[t._v("配置完成后，对网站发起请求，出现如下页面即日志接收成功")]),t._v(" "),e("p",[e("img",{attrs:{src:a(212),alt:""}}),t._v("\n点击 自动生成索引  确定即可")]),t._v(" "),e("p",[e("img",{attrs:{src:a(213),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"10"}},[e("li",[t._v("以上环节如出现问题请查看官方文档 https://help.aliyun.com/product/28958.html 或 找官方支持。")])]),t._v(" "),e("h2",{attrs:{id:"配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置"}},[t._v("#")]),t._v(" 配置")]),t._v(" "),e("p",[t._v("域名: 81.71.34.242")]),t._v(" "),e("p",[t._v("业务服务器IP: 81.71.32.242")]),t._v(" "),e("h4",{attrs:{id:"控制台配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#控制台配置"}},[t._v("#")]),t._v(" 控制台配置")]),t._v(" "),e("ol",[e("li",[t._v("添加网站")])]),t._v(" "),e("p",[t._v("网站配置 ->  添加网站")]),t._v(" "),e("p",[e("img",{attrs:{src:a(214),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[t._v("日志配置")])]),t._v(" "),e("p",[t._v("全局配置 -> 日志配置")]),t._v(" "),e("p",[e("img",{attrs:{src:a(163),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[t._v("阿里云日志配置")])]),t._v(" "),e("p",[t._v("全局配置 -> 阿里云日志配置\n"),e("img",{attrs:{src:a(215),alt:""}})]),t._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[t._v("报表展示")])]),t._v(" "),e("p",[e("img",{attrs:{src:a(216),alt:""}})])])}),[],!1,null,null,null);s.default=n.exports}}]);